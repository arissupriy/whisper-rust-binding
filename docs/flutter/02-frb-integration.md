# 🔗 Flutter Rust Bridge Integration
## FRB Configuration untuk Dual Library

### 🎯 Overview

Flutter Rust Bridge memungkinkan komunikasi seamless antara Flutter dan native Rust libraries. Untuk dual library setup (whisper + quran), kita perlu konfigurasi khusus.

### 📋 FRB Configuration

#### 1. flutter_rust_bridge.yaml

```yaml
# flutter_rust_bridge.yaml
rust_input:
  # Main whisper library
  - "../whisper-rust-binding/src/lib.rs"
  # Quran assistant engine  
  - "../quran_assistant_engine/src/lib.rs"

dart_output: "lib/generated"
c_output: 
  - "ios/Runner"
  - "android/app/src/main/cpp"

# Dual library configuration
rust_crate_dir: "../"
llvm_path: ["llvm-config"]

# Mobile optimization
extra_headers: |
  #include <stdint.h>
  #include <stdbool.h>
  #ifdef __ANDROID__
  #include <android/log.h>
  #endif

# Enable specific features for mobile
features:
  - "mobile-optimized"
  - "android-logging"

# Memory management for mobile
memory_strategy: "arc"
```

### 🔧 Rust Side Configuration

#### 1. Cargo.toml untuk Dual Library

```toml
# whisper-rust-binding/Cargo.toml
[package]
name = "whisper-rust-binding"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "rlib"]
name = "whisper_rust_binding"

[dependencies]
# Flutter Rust Bridge
flutter_rust_bridge = "2.0"

# Audio processing
hound = "3.5"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# Mobile logging
android_logger = { version = "0.13", optional = true }
log = "0.4"

# Error handling  
anyhow = "1.0"
thiserror = "1.0"

[features]
default = []
android-logging = ["android_logger"]
mobile-optimized = []

# Platform-specific features
[target.'cfg(target_os = "android")'.dependencies]
android_logger = "0.13"
```

### 🔄 Code Generation

#### 1. Generate Bindings Script

```bash
#!/bin/bash
# scripts/generate_bindings.sh

echo "🔧 Generating Flutter Rust Bridge bindings..."

# Clean previous generation
rm -rf lib/generated/
mkdir -p lib/generated/

# Generate for dual libraries
flutter_rust_bridge_codegen generate \
  --rust-input ../whisper-rust-binding/src/lib.rs \
  --rust-input ../quran_assistant_engine/src/lib.rs \
  --dart-output lib/generated \
  --extra-headers "
#include <stdint.h>
#include <stdbool.h>
" \
  --verbose

echo "✅ Bindings generated successfully!"

# Generate Dart code
dart run build_runner build --delete-conflicting-outputs

echo "🚀 Ready for development!"
```

#### 2. Generated Files Structure

```
lib/generated/
├── bridge_generated.dart          # Main FRB bridge
├── bridge_definitions.dart        # Type definitions
├── whisper_bridge.dart           # Whisper-specific bindings
└── quran_bridge.dart             # Quran-specific bindings
```

### 📱 Native Integration

#### 1. lib/generated/bridge_generated.dart (Example)

```dart
// Generated by flutter_rust_bridge
// ignore_for_file: non_constant_identifier_names, unused_element, duplicate_ignore, directives_ordering, curly_braces_in_flow_control_structures, unnecessary_lambdas, slash_for_doc_comments, prefer_const_literals_to_create_immutables, implicit_dynamic_list_literal, duplicate_import, unused_import, unnecessary_import, prefer_single_quotes, prefer_const_constructors, use_super_parameters, file_names, annotate_overrides, invalid_use_of_protected_member, camel_case_types, prefer_leading_positive_assertions

import 'dart:async';
import 'dart:convert';
import 'dart:ffi' as ffi;
import 'dart:typed_data';
import 'package:flutter_rust_bridge/flutter_rust_bridge.dart';

// Whisper Functions
abstract class WhisperApi {
  /// Initialize whisper with model path
  Future<int> whisperInit({required String modelPath});
  
  /// Free whisper instance
  Future<bool> whisperFree({required int instanceId});
  
  /// Process audio data
  Future<String> whisperProcessAudio({
    required int instanceId,
    required List<double> audioData,
    String? language,
  });
  
  /// Process with sliding window
  Future<String> whisperProcessAudioSlidingWindow({
    required int instanceId,
    required List<double> audioData,
    required double windowSizeSec,
    required double stepSizeSec,
    required int sampleRate,
    String? language,
  });
}

// Quran Functions  
abstract class QuranApi {
  /// Validate Arabic word
  Future<bool> validateArabicWord({
    required String word,
    required List<String> dictionary,
  });
  
  /// Get Quran verses containing word
  Future<List<QuranVerse>> searchQuranVerse({
    required String searchTerm,
  });
}

// Combined API
class DualLibraryApi implements WhisperApi, QuranApi {
  // Implementation akan di-generate oleh FRB
}
```

#### 2. Custom Type Definitions

```dart
// lib/generated/bridge_definitions.dart

class WhisperResult {
  final String text;
  final double confidence;
  final List<WhisperSegment> segments;
  
  const WhisperResult({
    required this.text,
    required this.confidence,
    required this.segments,
  });
}

class WhisperSegment {
  final double startTime;
  final double endTime;
  final String text;
  final double confidence;
  
  const WhisperSegment({
    required this.startTime,
    required this.endTime,
    required this.text,
    required this.confidence,
  });
}

class QuranVerse {
  final int surahNumber;
  final int verseNumber;
  final String arabicText;
  final String transliteration;
  final String translation;
  
  const QuranVerse({
    required this.surahNumber,
    required this.verseNumber,
    required this.arabicText,
    required this.transliteration,
    required this.translation,
  });
}

class AudioProcessingConfig {
  final int sampleRate;
  final int channels;
  final double windowSizeSec;
  final double stepSizeSec;
  final String language;
  
  const AudioProcessingConfig({
    this.sampleRate = 16000,
    this.channels = 1,
    this.windowSizeSec = 10.0,
    this.stepSizeSec = 5.0,
    this.language = 'ar',
  });
}
```

### 🔧 Runtime Configuration

#### 1. lib/services/bridge_service.dart

```dart
import 'dart:ffi' as ffi;
import 'dart:io';
import 'package:flutter_rust_bridge/flutter_rust_bridge.dart';
import '../generated/bridge_generated.dart';

class BridgeService {
  static DualLibraryApi? _api;
  static bool _initialized = false;
  
  static DualLibraryApi get api {
    if (!_initialized) {
      throw StateError('BridgeService not initialized. Call init() first.');
    }
    return _api!;
  }
  
  static Future<void> init() async {
    if (_initialized) return;
    
    try {
      // Load native libraries
      final dylib = _loadLibrary();
      
      // Initialize FRB
      _api = DualLibraryApiImpl(dylib);
      _initialized = true;
      
      print('✅ BridgeService initialized successfully');
    } catch (e) {
      print('❌ Failed to initialize BridgeService: $e');
      rethrow;
    }
  }
  
  static ffi.DynamicLibrary _loadLibrary() {
    if (Platform.isAndroid) {
      // Load both libraries for Android
      try {
        // Load whisper library
        final whisperLib = ffi.DynamicLibrary.open('libwhisper_rust_binding.so');
        
        // Load quran library  
        final quranLib = ffi.DynamicLibrary.open('libquran_assistant_engine.so');
        
        // Return combined library (or main library if they're linked)
        return whisperLib;
      } catch (e) {
        // Fallback to process library
        return ffi.DynamicLibrary.process();
      }
    } else if (Platform.isIOS) {
      return ffi.DynamicLibrary.process();
    } else {
      // Desktop
      if (Platform.isLinux) {
        return ffi.DynamicLibrary.open('libwhisper_rust_binding.so');
      } else if (Platform.isWindows) {
        return ffi.DynamicLibrary.open('whisper_rust_binding.dll');
      } else if (Platform.isMacOS) {
        return ffi.DynamicLibrary.open('libwhisper_rust_binding.dylib');
      }
    }
    
    throw UnsupportedError('Platform ${Platform.operatingSystem} is not supported');
  }
  
  static Future<void> dispose() async {
    _initialized = false;
    _api = null;
  }
}
```

#### 2. Initialize dalam main.dart

```dart
// lib/main.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'services/bridge_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize FRB
  await BridgeService.init();
  
  runApp(
    const ProviderScope(
      child: MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Quran Whisper App',
      theme: ThemeData(
        primarySwatch: Colors.green,
        useMaterial3: true,
      ),
      home: const HomeScreen(),
    );
  }
}
```

### 🧪 Testing Integration

#### 1. test/bridge_test.dart

```dart
import 'package:flutter_test/flutter_test.dart';
import '../lib/services/bridge_service.dart';

void main() {
  group('Bridge Integration Tests', () {
    setUpAll(() async {
      await BridgeService.init();
    });
    
    tearDownAll(() async {
      await BridgeService.dispose();
    });
    
    test('should initialize whisper', () async {
      final instanceId = await BridgeService.api.whisperInit(
        modelPath: 'test_model.bin',
      );
      
      expect(instanceId, greaterThanOrEqualTo(0));
      
      // Cleanup
      await BridgeService.api.whisperFree(instanceId: instanceId);
    });
    
    test('should validate Arabic word', () async {
      final isValid = await BridgeService.api.validateArabicWord(
        word: 'الله',
        dictionary: ['الله', 'الرحمن', 'الرحيم'],
      );
      
      expect(isValid, isTrue);
    });
  });
}
```

### 🔄 Next Steps

1. ✅ FRB setup selesai → Lanjut ke `03-models.md`
2. Define data models untuk type safety
3. Implement Riverpod providers
4. Create service layer

### 🐛 Common Issues

**Issue**: Library loading failed
```dart
// Solution: Check library paths and permissions
if (Platform.isAndroid) {
  // Ensure libraries are in correct directories:
  // android/app/src/main/jniLibs/arm64-v8a/
}
```

**Issue**: Binding generation fails
```bash
# Solution: Clean and regenerate
flutter clean
rm -rf lib/generated/
flutter_rust_bridge_codegen generate --force
```

**Issue**: Type mismatch errors
```dart
// Solution: Ensure Rust and Dart types match
// Rust: Vec<f32> -> Dart: List<double>
// Rust: String -> Dart: String
// Rust: Option<T> -> Dart: T?
```
